# 開発ログ (Development Log)

## 2024-12 ルビ表示機能の実装

### 概要
文語訳聖書のテキストに含まれる `漢字（ふりがな）` 形式を、HTMLの `<ruby>` タグを使った本来のルビ表示に変換する機能を実装。

### 実装ファイル
- `lib/ruby-parser.tsx` - ルビ解析・変換ロジック
- `app/globals.css` - ルビ表示用CSSスタイル
- `components/ChapterViewer.tsx` - 文語訳表示時にルビ変換を適用

### 重要な学び：シンプルなアプローチの勝利

#### 当初のアプローチ（複雑・失敗）
漢字を明示的にUnicode範囲で指定しようとした：
```javascript
// CJK統合漢字、拡張A/B、互換漢字など多数の範囲を指定
const rubyPattern = /([\u4E00-\u9FFF\u3400-\u4DBF\uF900-\uFAFF...]+)（...）/gu;
```

**問題点：**
- 文語訳聖書には旧字体（例：神 U+FA19）が含まれており、想定外のUnicode範囲の文字があった
- 範囲を追加し続けても、未知の文字に対応できない

#### 最終的なアプローチ（シンプル・成功）
「漢字とは何か」ではなく「漢字でないものは何か」という逆転の発想：
```javascript
// ひらがな・括弧・空白・句読点以外 = 漢字として扱う
const excluded = `（）\\s${hiragana}${punctuation}`;
const rubyPattern = new RegExp(`([^${excluded}]+)（([${rubyChars}]+)）`, 'gu');
```

**利点：**
- 旧字体・異体字など、どんな漢字でも自動的に対応
- シンプルで理解しやすい
- データセットの性質（文語訳聖書には絵文字やラテン文字が混入しない）を活かした設計

### 教訓
> 「データセットの性質を理解しているにもかかわらず、汎用的な解決策を求めて複雑化してしまった」
>
> 固定的で性質が分かっているデータセットに対しては、文脈を踏まえたシンプルな解決策が有効。

---

## 2024-12 旧約聖書引用（クロスリファレンス）機能

### 概要
新約聖書の箇所を表示する際に、引用されている旧約聖書の箇所を表示する機能。

### 実装ファイル
- `lib/cross-references.ts` - 引用データと取得ロジック

### 対応済み書簡
- マタイによる福音書
- マルコによる福音書
- ルカによる福音書
- ヨハネによる福音書
- 使徒行伝
- ローマ人への手紙
- コリント人への第一の手紙
- コリント人への第二の手紙
- エペソ人への手紙
- コロサイ人への手紙
- ペテロの第一の手紙
- ペテロの第二の手紙
- ヤコブの手紙
- ユダの手紙
- テモテへの第二の手紙

---

## 原典ギリシャ語学習機能

### 概要
新約聖書のギリシャ語原典を学習するための専用ページ。単語ごとに分解し、カタカナ音写、品詞、文法情報、日本語グロス（意味）を表示。

### アクセス
`/greek` - メイン学習ページ
`/greek/guide` - 学習ガイド（アルファベット、文法、ヨハネ福音書入門、学習のコツ）

### 実装ファイル
- `app/greek/page.tsx` - メイン学習ページ
- `app/greek/guide/` - 学習ガイド各ページ
- `components/GreekVerseView.tsx` - 節表示コンポーネント
- `components/GreekWordDetail.tsx` - 単語詳細モーダル
- `components/GreekSettingsModal.tsx` - 設定モーダル
- `lib/greek-data.ts` - データ取得ロジック
- `types/greek.ts` - 型定義
- `data/greek/` - 各書のギリシャ語データ（JSON）

### 学習レベル
1. **初級（beginner）**: カタカナ音写 + 日本語の意味を表示
2. **中級（intermediate）**: ローマ字音写 + 品詞を表示
3. **上級（advanced）**: ギリシャ語テキストのみ

### データ構造
```typescript
interface GreekWord {
  text: string;           // ギリシャ語テキスト（例: "Ἐν"）
  lemma: string;          // 辞書形（例: "ἐν"）
  katakana: string;       // カタカナ音写（例: "エン"）
  pos: string;            // 品詞コード
  posName: string;        // 品詞名（例: "前置詞"）
  morph: GreekMorphology; // 文法情報（人称、時制、態、法、格、数、性）
  gloss: string;          // 日本語グロス（例: "〜の中で"）
}
```

### 対応範囲
新約聖書全27書のギリシャ語データを収録：
- 福音書: マタイ、マルコ、ルカ、ヨハネ
- 歴史: 使徒行伝
- パウロ書簡: ローマ〜ピレモン（13書）
- 一般書簡: ヘブル〜ユダ（8書）
- 黙示文学: ヨハネの黙示録

### 課題・改善点
1. **データ品質**: 一部の単語でグロス（日本語訳）が不完全な場合がある
2. **カタカナ音写の精度**: 古典ギリシャ語の発音規則に基づいているが、異なる発音体系（現代ギリシャ語等）もある
3. **文法解析**: 形態素解析は機械的に行われているため、文脈依存の解釈が必要な箇所がある
4. **UIの最適化**: モバイルでの長い節の表示が煩雑になることがある

---

## データクリーニング

### 文語訳聖書ページ番号削除
`〘N㌻〙` 形式のページ番号表記を削除（1607箇所）
```bash
sed -i 's/〘[0-9]*㌻〙//g' data/bible-bungo.json
```
